<script>
	document.readyState == "loading" ?
		document.addEventListener("DOMContentLoaded", srinit) :
		srinit()

	function srinit ()
	{
		try
		{
			const style = document.createElement('style')            
			document.head.appendChild(style)    
			style.sheet.insertRule("nav div > a[href='#/cards'] { display: none; }")
		}
		catch (ex)
		{
			console.error(ex)
		}

		try
		{
			const metadesc = document.querySelector("meta[name=description]")
			if (metadesc)
				document.querySelector("p[class*=--seo-search-banner]").textContent = metadesc.content
		}
		catch (ex)
		{
			console.error(ex)
		}

		try
		{
			document.addEventListener("click", (ev) =>
			{
				if (ev.target.className.match(/--iconSearchImage\s/))
				{
					const search = document.querySelector("[class*=--icon-close-search-mob]")

					search.classList.toggle("open")

					if (search.classList.contains("open"))
						search.focus()
				}
			})
		}
		catch (ex)
		{
			console.error(ex)
		}
	}
</script>
<link rel="stylesheet" href="https://pillin.myvtex.com/files/pillin-custom-account.css" />
<meta name="referrer" content="no-referrer-when-downgrade">
<script>
  (function() {
    console.log("Tallas script ran from pixel");
  })()

/* --------------------------------------------------------------------------------- */

function find_parent(n,e)
{
  while ( e && e.nodeName !== n ) e = e.parentNode;
  return e;
}

document.addEventListener('click', function(evt)
{
  if (evt == null) return;

try
{
  let temp0 = evt.target;
  let filtrar = false;

  if ( temp0.firstChild.data == "Filtrar") filtrar = true;
 // if ( temp0.firstChild.data == "GuÃ­a de Tallas") alert('');
  if ( temp0.firstChild.firstChild !== null && temp0.firstChild.firstChild.data == "Filtrar") filtrar = true;

  if (filtrar)
  {
    let tallas = document.querySelectorAll('.selected_talla');
    let titulo = document.querySelector('.vtex-rich-text-0-x-paragraph--tituloModal').firstChild.data;
    let re1    = /listItem--([^-\s]+)--mapequals([^-\s]+)---([^-\s]+)[-]*specificationFilter-([0-9]+)/;
    let re2    = /menuItem--([^-\s]+)-specificationFilter_([0-9]+) /;
    
    let tipo = '', extra='';
    let cat = '', map='', tip='', sf='', url='', uri='';
    
    if (titulo == "Accesorios")
    {
      re2    = /menuItem--([^\s]+)-specificationFilter_([0-9]+)/;
      url = "/"+titulo.toLowerCase()+"/";
      map = 'c';
    }
    else
    {
      let tipo   = document.querySelector('.vtex-tab-layout-0-x-listItemActive');
      let t = re1.exec( tipo.classList );

      if ( t==null) return;
    
      if ( t.length > 3)
      {   
        cat = t[1];
        map = t[2];
        tip = t[3];
        sf  = t[4];
      }   
      else
        return;
      
      url = "/"+cat+"/";
      uri = ""; 
      extra = ",specificationFilter_" + sf;
    }

    tallas.forEach( (x)=>
    {
      let d = re2.exec( x.classList );
      if (d==null) return;
      url += d[1].toLowerCase() + "/";
      uri += ",specificationFilter_"+d[2];
    });
    url += tip + "?map=" + map + uri + extra;
    
    top.location.href = url;
    return;
  }

  if ( temp0.className.indexOf("-specificationFilter")>0 )
  {
    if ( temp0.nodeName != "LI" )
    {
      temp0 = find_parent("LI",temp0);
      if (temp0 == null) return;
    }

    if (temp0.classList.contains('selected_talla'))
    {
      temp0.classList.remove("selected_talla");
      temp0.style.background = '';
    }
    else
    {
      temp0.classList.add("selected_talla");
      temp0.style.background = '#ece3cc';
    }
  }

}
catch(e)
{
}


}
, true);

/* ---------------------------------------------------------------------------------------- */

</script>

		<script async="async">
//			document.addEventListener("DOMContentLoaded", srestoresinit)

			function srestoresinit ()
			{
				if (!document.getElementById("map"))
					return

				setTimeout(srvtexinit, 0)

				const script = document.createElement("script")

				script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyAKvpKOzDVG8dsSz90L6OQZuUJ0qh0CvSc&v=beta"
				script.addEventListener("load", srmapinit)

				document.head.appendChild(script)
			}

			let map, geo, mark, info

			function srmapinit (ev)
			{
				const div = document.querySelector("#map > div")
				map = new google.maps.Map(div, {
					center: { lat: -34.397, lng: 150.644 },
					zoom:   8,
					gestureHandling: "none",
					disableDefaultUI: true })
				map.panTo({ lat: -33.589958, lng: -70.695051 })

				mark = new google.maps.Marker({ map, visible: false })
				info = new google.maps.InfoWindow
				geo  = new google.maps.Geocoder
			}

			async function mappancoord (coord, title)
			{
				if (!map)
					return

				map.panTo(coord)
				map.setZoom(16)

				mark.setPosition(coord)
				mark.setVisible(true)
				info.setContent(title)
				info.open(map, mark)
			}

			async function mappanarray (order)
			{
				if (!map || !geo)
					return

				mark.setVisible(false)
				info.close()

				const component = [ "Chile" ]

				for (const select of order)
				if (select.value != 0)
					component.unshift(select.value)
				else break

				console.log(component)
				const ret = await geo.geocode({ address: component.join(",") })

				console.log("ret", ret.results.length, ret)

				map.fitBounds(ret.results[0].geometry.bounds, 10)
			}

			async function srvtexinit ()
			{
//				const fetched = window.data = await fetch("/api/logistics/pvt/configuration/pickuppoints", { headers: { "X-VTEX-API-AppKey":   "vtexappkey-pillin-KTRDYS", "X-VTEX-API-AppToken": "QHMNBTTFTYSQIBJWBUCRZLKNWZNPYATTCKERYJYDVRUZETBXRIYVUNCFXYRCFDHSEYOXXRXSWZVIRLICXQYQCXYOIZUZRWXRJBUGFEAZKFZVRUNLQPEPFRQHAZPXXXAA"}})
				const list = window.vtexlist

				const places  = {}
				const reglat  = {}
				const regarr  = []
				const regtree = {}

				for (const item of list)
				{
					const region  = item.address.state
					const commune = item.address.neighborhood

					if (places[region] == undefined)
					{
						places[region] = {}
						reglat[region] = item.address.location.latitude
						regarr.push(region)
					}

					if (places[region][commune] == undefined)
						places[region][commune] = {}

					places[region][commune][item.name] = item
				}

				regarr.sort((a, b) => reglat[b] - reglat[a])

				for (const region of regarr)
					regtree[region] = places[region]

				console.log("REG", regtree)

				const order = [
					document.getElementById("address_region"),
					document.getElementById("address_commune"),
					document.getElementById("address_store")
				]

				populate(order[0], regtree)

				for (const item of order)
					item.addEventListener("input", change)

				function change (ev)
				{
					console.log("change", this)
					const index = order.indexOf(this)

					if (order[index].options[0].value == 0)
						order[index].remove(0)

					for (const select of order.slice(index +1))
					{
						while (select.options.length)
							select.remove(0)

						select.disabled = true
					}

					let tree = regtree
					let i    = 0

					do
					{
						if (order[i] == undefined)
						{
							i = undefined
							break
						}

						if (order[i].value)
							tree = tree[order[i].value]
						else break
					}
					while (++i)

					if (i != undefined)
					{
						const select = order[i]

						populate(select, tree)
						fillcard()
						mappanarray(order)
					}
					else
					{
						const store = tree

						setTimeout(mappancoord, 0, {
								lat: store.address.location.latitude,
								lng: store.address.location.longitude },
							store.name)

						fillcard(store)
					}
				}

				function populate (select, collection)
				{
					console.log("populating", select)
					const option = document.createElement("option")
					option.text  = "Seleccionar"
					option.value = 0
					select.add(option)

					for (let name in collection)
					{
						const option = document.createElement("option")
						option.text = name
						select.add(option)
					}

					select.disabled = false
				}

				function fillcard (store)
				{
					console.log("store", store)
					const data = {
						name:     "n/a",
						address:  "n/a",
						schedule: "n/a",
						contact:  "n/a",
					}

					if (store != undefined)
					{
						let today = (new Date).getDay()
						let hours
						let sched

						for (const item of store.businessHours)
						if  (item.dayOfWeek == today)
						{
							hours = item
							break
						}

						if (hours == undefined)
							hours = store.businessHours[0]

						sched = (hours != undefined) ?
							`${/^\d\d:\d\d/.exec(hours.openingTime)[0]}hrs - ` +
							`${/^\d\d:\d\d/.exec(hours.closingTime)[0]}hrs` :
							"n/a"


						data.name     = store.name
						data.address  = `${store.address.street} ${store.address.number}`
						data.schedule = sched
						data.contact  = store.address.complement

						document.getElementById("store_info").classList.add("populated")
					}
					else
						document.getElementById("store_info").classList.remove("populated")

					for (const key in data)
						document.getElementById(`slot_${key}`).textContent = data[key]
				}
			}
		</script>



		<style>
			.gm-style-iw button {
				display: none !important;
			}
			* {
				box-sizing: border-box;
			}
			#cont {
				position: relative;
				overflow: hidden;
				min-height: 30em;
			}
			#form {
				text-align: left;
				vertical-align: top;

				position: relative;
				z-index: 1;
				padding: 2em;
				background-color: #F7F1E7;
				box-shadow: 0 0 1em -0.2em black;
			}
			#map {
				position: relative;
				height: 20em;
			}
			#map > * {
				position: absolute;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
			}
			#form > * {
				margin: 0;
				padding: 0.5em;
			}
			#form > label {
				display: block;
			}
			#form > select {
				min-width: 100%;
			}
			#store_info {
				visibility: collapse;
			}
			#store_info.populated {
				visibility: visible;
			}
			@media (min-width: 991px)
			{
				#form {
					margin: 4em;
					width: 30em;
					border-radius: 0.5em;
				}
				#map {
					position: absolute;
					height: auto;
					top: 0;
					right: 0;
					bottom: 0;
					left: 0;
				}
			}
		</style>

